<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes"
    />
    <title>ç•ªèŒ„æ—¶é’Ÿ </title>
    <!-- Font Awesome 6 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- Google Font: Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- jQuery -->
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <!-- ç®€å•faviconé¿å…404 -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ…</text></svg>"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background: linear-gradient(145deg, #fef9e7 0%, #fff7e0 100%);
        font-family: "Inter", sans-serif;
        padding: 2rem 1.5rem;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #2d3e50;
      }
      .container {
        max-width: 800px;
        width: 100%;
      }

      /* æ—¥æœŸé¼“åŠ±å¡ç‰‡ï¼ˆå»æ‰å£°éŸ³æµ‹è¯•ï¼Œåªç•™æ—¥æœŸå’Œé¼“åŠ±ï¼‰ */
      .date-encourage-card {
        background: rgba(255, 235, 215, 0.7);
        backdrop-filter: blur(8px);
        border-radius: 60px;
        padding: 0.9rem 1.8rem;
        margin-bottom: 18px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #ffdbb5;
        box-shadow: 0 8px 18px #fbe6d4;
        font-weight: 500;
        color: #784b2e;
      }
      .date-info {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .date-info i {
        color: #c96b4a;
        margin-right: 4px;
      }
      .encourage-box {
        background: #faead3;
        padding: 6px 18px;
        border-radius: 40px;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #5a3a22;
      }
      .encourage-text {
        font-style: italic;
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .refresh-encourage {
        background: none;
        border: none;
        color: #b9784b;
        font-size: 1.1rem;
        cursor: pointer;
        transition: 0.2s;
        padding: 4px;
      }
      .refresh-encourage:hover {
        color: #8e4d2a;
        transform: rotate(60deg);
      }

      /* è®¡æ—¶å¡ç‰‡ */
      .timer-card {
        background: rgba(255, 248, 235, 0.7);
        backdrop-filter: blur(12px);
        border-radius: 48px;
        padding: 2rem 1.5rem;
        box-shadow: 0 20px 35px -10px rgba(235, 120, 50, 0.2);
        border: 1px solid rgba(255, 215, 170, 0.5);
        margin-bottom: 28px;
        text-align: center;
      }
      .mode-badge {
        display: inline-block;
        background: #ffb085;
        padding: 8px 20px;
        border-radius: 40px;
        color: #4a2512;
        font-weight: 600;
        font-size: 1rem;
        letter-spacing: 1px;
        box-shadow: 0 4px 8px #ffe6d5;
        margin-bottom: 20px;
        border: 1px solid #ffe0c0;
      }
      .timer-display {
        font-size: 5.5rem;
        font-weight: 700;
        font-feature-settings: "tnum";
        color: #77450e;
        line-height: 1;
        margin: 0.2rem 0 0.5rem;
        text-shadow: 0 4px 12px rgba(255, 140, 60, 0.2);
      }
      .btn-group-custom {
        display: flex;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
        margin-top: 24px;
      }
      .btn-tomato {
        border: none;
        background: white;
        padding: 12px 24px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow:
          0 6px 0 #d6895f,
          0 10px 20px #ffc9a9;
        transition: all 0.06s ease;
        color: #5a3e1b;
        border: 1px solid #ffe1c6;
      }
      .btn-tomato:active {
        transform: translateY(6px);
        box-shadow:
          0 2px 0 #b5673f,
          0 12px 20px #ffc9a9;
      }
      .btn-tomato i {
        font-size: 1.1rem;
        color: #c94f1f;
      }
      .btn-reset {
        background: #fff4e5;
        box-shadow:
          0 6px 0 #dbb28b,
          0 10px 20px #ffe0cd;
      }
      /* æ–°å¢ï¼šå£°éŸ³æµ‹è¯•æŒ‰é’®æ ·å¼ï¼ˆä¸å¼€å§‹é‡ç½®ä¸€è‡´ä½†ä¸åŒè‰²ï¼‰ */
      .btn-sound {
        background: #ffece5;
        box-shadow:
          0 6px 0 #c48b74,
          0 10px 20px #ffd5c2;
        border: 1px solid #ffb694;
      }
      .btn-sound i {
        color: #9f5e40;
      }

      /* è‡ªå®šä¹‰æ—¶é—´è®¾ç½® */
      .settings-row {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 28px;
        background: rgba(255, 235, 215, 0.5);
        padding: 16px 20px;
        border-radius: 100px;
        backdrop-filter: blur(4px);
      }
      .settings-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #683f1e;
        font-weight: 500;
      }
      .settings-item label {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .number-input {
        width: 75px;
        padding: 8px 12px;
        border-radius: 40px;
        border: 1px solid #ffbb8a;
        background: white;
        font-weight: 600;
        text-align: center;
        font-size: 1rem;
        color: #4f2d12;
        outline: none;
        transition: 0.2s;
      }
      .number-input:focus {
        border-color: #ff6b4a;
        box-shadow: 0 0 0 3px rgba(255, 139, 86, 0.3);
      }

      /* æ‰‹åŠ¨è®°å½•å¡ç‰‡ */
      .record-card {
        background: white;
        border-radius: 36px;
        padding: 1.8rem 1.6rem;
        box-shadow: 0 15px 30px #edd7bf;
        margin-bottom: 28px;
        border: 1px solid #ffe5d0;
      }
      .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        color: #6b3f00;
        margin-bottom: 22px;
        font-size: 1.3rem;
        border-bottom: 2px dashed #ffc293;
        padding-bottom: 12px;
      }
      .input-group-jq {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .row-flex {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        align-items: center;
      }
      .select-mode {
        background: #ffefdd;
        border: 1px solid #ffbb8a;
        border-radius: 40px;
        padding: 12px 22px;
        font-weight: 500;
        color: #562e0e;
        outline: none;
      }
      .note-input {
        flex: 1;
        min-width: 200px;
        background: #fffaf2;
        border: 1px solid #ffcfaa;
        border-radius: 50px;
        padding: 12px 24px;
        font-size: 1rem;
        transition: 0.2s;
      }
      .note-input:focus {
        background: white;
        border-color: #ff8a5c;
        box-shadow: 0 0 0 3px rgba(255, 158, 90, 0.3);
      }
      .btn-save {
        background: #f5a65b;
        border: none;
        border-radius: 50px;
        padding: 12px 28px;
        color: white;
        font-weight: 600;
        border-bottom: 4px solid #c2712e;
        transition: 0.08s;
      }
      .btn-save:active {
        border-bottom-width: 2px;
        transform: translateY(2px);
      }

      /* ç»„å†å²è®°å½•æ ·å¼ */
      .history-card {
        background: rgba(255, 245, 235, 0.8);
        backdrop-filter: blur(4px);
        border-radius: 36px;
        padding: 1.8rem 1.6rem;
        border: 1px solid #ffdbb5;
      }
      .group-item {
        background: #fff8f0;
        border-radius: 28px;
        padding: 1.4rem 1.5rem;
        margin-bottom: 24px;
        border: 1px solid #ffd9b0;
        box-shadow: 0 8px 18px #faded3;
      }
      .group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #ffd8b0;
      }
      .group-title {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .group-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: #6b3f1c;
        background: #fff1e0;
        padding: 5px 18px;
        border-radius: 40px;
        border: 1px solid #ffb27f;
      }
      .group-badge {
        background: #d49b7a;
        color: white;
        padding: 4px 14px;
        border-radius: 30px;
        font-size: 0.8rem;
        font-weight: 600;
      }
      .group-actions {
        display: flex;
        gap: 12px;
      }
      .btn-icon {
        background: none;
        border: 1px solid #ffac7a;
        border-radius: 30px;
        padding: 6px 16px;
        color: #7b4a2a;
        transition: 0.2s;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
      }
      .btn-icon i {
        font-size: 0.95rem;
      }
      .btn-icon:hover {
        background: #ffe2d0;
        border-color: #ff7e4e;
      }
      .btn-delete-group {
        border-color: #ff9292;
        color: #b04949;
      }
      .btn-delete-group:hover {
        background: #ffe0e0;
      }

      .group-detail {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-left: 6px;
      }
      .session-row {
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        background: #fffbf5;
        padding: 10px 18px;
        border-radius: 30px;
      }
      .session-type {
        width: 70px;
        font-weight: 600;
      }
      .work-type {
        color: #c94f1f;
      }
      .break-type {
        color: #3a8b6b;
      }
      .session-time {
        color: #946b54;
        font-size: 0.9rem;
        margin-left: 16px;
      }
      .session-note {
        margin-left: 20px;
        font-style: italic;
        color: #5e4b3a;
        background: #ffeddc;
        padding: 4px 14px;
        border-radius: 30px;
      }
      .group-footer {
        margin-top: 16px;
        display: flex;
        align-items: center;
        gap: 18px;
        flex-wrap: wrap;
        background: #fff5e8;
        padding: 12px 18px;
        border-radius: 50px;
      }
      .group-remark {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
      }
      .remark-text {
        color: #7b4a2a;
        background: white;
        padding: 5px 16px;
        border-radius: 40px;
        border: 1px dashed #ffa25b;
      }
      .empty-group-remark {
        color: #b38f75;
        font-style: italic;
      }

      .single-record-item {
        background: #fff9f0;
        border-radius: 20px;
        padding: 1rem 1.3rem;
        margin-bottom: 10px;
        border: 1px solid #ffe0be;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .delete-btn {
        background: none;
        border: none;
        color: #b93e3e;
        font-size: 1.3rem;
        cursor: pointer;
        transition: 0.1s;
        padding: 8px;
      }
      .delete-btn:hover {
        color: #d00000;
        transform: scale(1.1);
      }
      .empty-history {
        text-align: center;
        color: #b58f7a;
        padding: 30px 10px;
        font-style: italic;
      }
      .btn-clear-all {
        background: #ffc2a1;
        border: none;
        border-radius: 60px;
        padding: 12px 28px;
        color: #4a2c1a;
        font-weight: 600;
        margin-top: 24px;
        width: 100%;
        border-bottom: 4px solid #b77a5a;
        transition: 0.06s;
      }
      .btn-clear-all:active {
        transform: translateY(4px);
        border-bottom-width: 2px;
      }
      footer {
        margin-top: 25px;
        color: #c9a78b;
        font-size: 0.8rem;
        text-align: center;
      }
      .hint {
        font-size: 0.8rem;
        color: #a17c5e;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ========= æ—¥æœŸ + é¼“åŠ±è¯­ï¼ˆå£°éŸ³æµ‹è¯•æŒ‰é’®å·²ç§»è‡³è®¡æ—¶åŒºï¼‰========= -->
      <div class="date-encourage-card">
        <div class="date-info">
          <span
            ><i class="far fa-calendar-alt"></i>
            <span id="currentDateDisplay"></span
          ></span>
          <span
            ><i class="far fa-calendar-check"></i> æœ¬æœˆ
            <span id="daysInMonth"></span> å¤©</span
          >
        </div>
        <div class="encourage-box">
          <i class="fas fa-leaf" style="color: #689f38"></i>
          <span id="encourageMessage" class="encourage-text"
            >ä»Šå¤©ä¹Ÿæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©ï¼</span
          >
          <button
            id="refreshEncourageBtn"
            class="refresh-encourage"
            title="æ¢ä¸€å¥é¼“åŠ±"
          >
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>

      <!-- ç•ªèŒ„è®¡æ—¶å™¨å¡ç‰‡ï¼ˆåŒ…å«å£°éŸ³æµ‹è¯•æŒ‰é’®ï¼‰ -->
      <div class="timer-card">
        <span class="mode-badge" id="currentModeLabel"
          ><i class="fas fa-tomato"></i> ä¸“æ³¨å·¥ä½œ</span
        >
        <div class="timer-display" id="timerDisplay">25:00</div>
        <div class="settings-row">
          <div class="settings-item">
            <label for="workMinutes"
              ><i class="fas fa-tomato" style="color: #e1704b"></i> å·¥ä½œ
              (åˆ†)</label
            >
            <input
              type="number"
              id="workMinutes"
              class="number-input"
              value="25"
              min="1"
              max="99"
              step="1"
            />
          </div>
          <div class="settings-item">
            <label for="breakMinutes"
              ><i class="fas fa-mug-hot" style="color: #58967a"></i> ä¼‘æ¯
              (åˆ†)</label
            >
            <input
              type="number"
              id="breakMinutes"
              class="number-input"
              value="5"
              min="1"
              max="99"
              step="1"
            />
          </div>
        </div>
        <div class="hint">
          <i class="fas fa-sliders-h"></i>
          ä¿®æ”¹æ•°å­—è‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ­£åœ¨è®¡æ—¶ä¸å½±å“å½“å‰å‰©ä½™æ—¶é—´
        </div>
        <div class="btn-group-custom">
          <button class="btn-tomato" id="startPauseBtn">
            <i class="fas fa-play" id="startPauseIcon"></i> å¼€å§‹
          </button>
          <button class="btn-tomato btn-reset" id="resetBtn">
            <i class="fas fa-undo-alt"></i> é‡ç½®
          </button>
          <!-- å£°éŸ³æµ‹è¯•æŒ‰é’®ç§»åˆ°è¿™é‡Œï¼Œä¸å¼€å§‹é‡ç½®åŒä¸€è¡Œ -->
          <button class="btn-tomato btn-sound" id="testSoundBtn">
            <i class="fas fa-volume-up"></i> å£°éŸ³æµ‹è¯•
          </button>
        </div>
        <p style="margin-top: 22px; color: #9f7e66">
          <i class="far fa-clock"></i> è‡ªåŠ¨å¾ªç¯Â·é•¿æç¤ºéŸ³Â·æˆç»„æ˜¾ç¤º
        </p>
      </div>

      <!-- æ‰‹åŠ¨æ·»åŠ è®°å½• (ä¸è‡ªåŠ¨åˆ†ç»„ï¼Œsession_idä¸ºç©º) -->
      <div class="record-card">
        <div class="section-title">
          <i class="fas fa-pen-fancy" style="color: #eb7d42"></i> æ‰‹åŠ¨æ·»åŠ è®°å½•
        </div>
        <div class="input-group-jq">
          <div class="row-flex">
            <select id="recordTypeSelect" class="select-mode">
              <option value="work">ğŸ… å·¥ä½œ</option>
              <option value="break">ğŸ§˜ ä¼‘æ¯</option>
            </select>
            <input
              type="text"
              id="recordNote"
              class="note-input"
              placeholder="å†™ä¸‹å¤‡æ³¨..."
            />
            <button class="btn-save" id="saveRecordBtn">
              <i class="fas fa-save"></i>ä¿å­˜è®°å½•
            </button>
          </div>
          <small style="color: #bb7a5a"
            ><i class="fas fa-info-circle"></i>
            æ‰‹åŠ¨è®°å½•ä¸è‡ªåŠ¨åˆ†ç»„ï¼Œä¼šæ˜¾ç¤ºåœ¨ä¸‹æ–¹ã€Œå…¶ä»–è®°å½•ã€ä¸­</small
          >
        </div>
      </div>

      <!-- å†å²è®°å½•ï¼šå…ˆå±•ç¤ºç•ªèŒ„ç»„ï¼Œå†å±•ç¤ºæœªåˆ†ç»„çš„å•æ¡è®°å½• -->
      <div class="history-card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: baseline;
          "
        >
          <div class="section-title" style="margin-bottom: 12px">
            <i class="fas fa-history" style="color: #cd7b4b"></i> ç•ªèŒ„ä¼šè¯ç»„
          </div>
          <button id="clearAllBtn" class="btn-icon" style="background: #ffe0d0">
            <i class="fas fa-trash-alt"></i> ä¸€é”®åˆ é™¤æ‰€æœ‰
          </button>
        </div>
        <!-- ç»„åˆ—è¡¨æ¸²æŸ“ä½ç½® -->
        <div id="groupListContainer"></div>

        <!-- åˆ†éš”çº¿ -->
        <hr style="border: 1px dashed #ffd9b0; margin: 28px 0 20px" />
        <div
          style="
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
          "
        >
          <i class="fas fa-list-ul" style="color: #b7774b"></i>
          <span style="font-weight: 600; color: #6b3f00"
            >å…¶ä»–è®°å½•ï¼ˆæœªåˆ†ç»„ï¼‰</span
          >
        </div>
        <div id="singleRecordListContainer"></div>
      </div>
      <footer>
        â³ æ•°æ®å­˜å‚¨äº IndexedDB Â· è‡ªåŠ¨æˆç»„Â·å¯ç¼–è¾‘ç»„å/å¤‡æ³¨ Â· ä¸€é”®æ¸…ç©º Â·
        å£°éŸ³æµ‹è¯•å·²æ•´åˆ
      </footer>
    </div>

    <script>
      // =======================  å°†æ‰€æœ‰DOMå˜é‡å®šä¹‰åœ¨å¼€å¤´ï¼Œé¿å…æœªå®šä¹‰é”™è¯¯ =======================
      (function () {
        "use strict";

        // ---------- DOM å…ƒç´ å®šä¹‰ï¼ˆç«‹å³æ‰§è¡Œï¼Œç¡®ä¿å­˜åœ¨ï¼‰----------
        const $timerDisplay = $("#timerDisplay");
        const $modeLabel = $("#currentModeLabel");
        const $startPauseBtn = $("#startPauseBtn");
        const $startPauseIcon = $("#startPauseIcon");
        const $resetBtn = $("#resetBtn");
        const $testSoundBtn = $("#testSoundBtn"); // å£°éŸ³æµ‹è¯•æŒ‰é’®
        const $saveRecordBtn = $("#saveRecordBtn");
        const $recordType = $("#recordTypeSelect");
        const $recordNote = $("#recordNote");
        const $historyContainer = $("#historyListContainer"); // ä¿ç•™å¤‡ç”¨
        const $workMinutesInput = $("#workMinutes");
        const $breakMinutesInput = $("#breakMinutes");
        const $clearAllBtn = $("#clearAllBtn");
        const $refreshEncourageBtn = $("#refreshEncourageBtn");

        // =======================  IndexedDB ç‰ˆæœ¬2: å¢åŠ  sessionGroups ä»“åº“ + session_id ç´¢å¼• =======================
        const DB_NAME = "PomodoroDB";
        const DB_VERSION = 2;
        const STORE_SESSIONS = "tomatoSessions";
        const STORE_GROUPS = "sessionGroups";

        function openDB() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => reject(event.target.error);
            request.onsuccess = (event) => resolve(event.target.result);
            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              const tx = event.target.transaction;
              // 1. sessions ä»“åº“
              if (!db.objectStoreNames.contains(STORE_SESSIONS)) {
                const store = db.createObjectStore(STORE_SESSIONS, {
                  keyPath: "id",
                  autoIncrement: true,
                });
                store.createIndex("timestamp", "timestamp", { unique: false });
                store.createIndex("type", "type", { unique: false });
              }
              // æ·»åŠ  session_id ç´¢å¼• (ç‰ˆæœ¬å‡çº§)
              const sessionsStore = tx.objectStore(STORE_SESSIONS);
              if (!sessionsStore.indexNames.contains("session_id")) {
                sessionsStore.createIndex("session_id", "session_id", {
                  unique: false,
                });
              }
              // 2. ç»„ä»“åº“
              if (!db.objectStoreNames.contains(STORE_GROUPS)) {
                const groupStore = db.createObjectStore(STORE_GROUPS, {
                  keyPath: "session_id",
                });
                groupStore.createIndex("createdAt", "createdAt", {
                  unique: false,
                });
              }
            };
          });
        }

        // ========== ä¼šè¯ç»„ CRUD ==========
        async function createGroup(session_id, defaultName = "ç•ªèŒ„ä¼šè¯") {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_GROUPS, "readwrite");
            const store = tx.objectStore(STORE_GROUPS);
            const group = {
              session_id: session_id,
              name: defaultName,
              remark: "",
              createdAt: new Date().toISOString(),
            };
            const request = store.add(group);
            request.onsuccess = () => resolve(session_id);
            request.onerror = (err) => reject(err);
            tx.oncomplete = () => db.close();
          });
        }

        async function updateGroup(session_id, updates) {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_GROUPS, "readwrite");
            const store = tx.objectStore(STORE_GROUPS);
            const getReq = store.get(session_id);
            getReq.onsuccess = () => {
              const group = getReq.result;
              if (!group) {
                reject("ç»„ä¸å­˜åœ¨");
                return;
              }
              if (updates.name !== undefined) group.name = updates.name;
              if (updates.remark !== undefined) group.remark = updates.remark;
              const putReq = store.put(group);
              putReq.onsuccess = () => resolve();
              putReq.onerror = (err) => reject(err);
            };
            getReq.onerror = (err) => reject(err);
            tx.oncomplete = () => db.close();
          });
        }

        async function deleteGroupAndSessions(session_id) {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(
              [STORE_SESSIONS, STORE_GROUPS],
              "readwrite",
            );
            const sessionStore = tx.objectStore(STORE_SESSIONS);
            const groupStore = tx.objectStore(STORE_GROUPS);

            const index = sessionStore.index("session_id");
            const range = IDBKeyRange.only(session_id);
            index.openCursor(range).onsuccess = (event) => {
              const cursor = event.target.result;
              if (cursor) {
                sessionStore.delete(cursor.primaryKey);
                cursor.continue();
              }
            };
            groupStore.delete(session_id);
            tx.oncomplete = () => {
              db.close();
              resolve();
            };
            tx.onerror = (err) => {
              db.close();
              reject(err);
            };
          });
        }

        async function getAllGroupsWithSessions() {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(
              [STORE_GROUPS, STORE_SESSIONS],
              "readonly",
            );
            const groupStore = tx.objectStore(STORE_GROUPS);
            const sessionStore = tx.objectStore(STORE_SESSIONS);
            const groups = [];
            groupStore.openCursor().onsuccess = (event) => {
              const cursor = event.target.result;
              if (cursor) {
                const group = cursor.value;
                const index = sessionStore.index("session_id");
                const req = index.getAll(group.session_id);
                req.onsuccess = () => {
                  group.sessions = req.result || [];
                };
                groups.push(group);
                cursor.continue();
              }
            };
            tx.oncomplete = () => {
              groups.sort(
                (a, b) => new Date(b.createdAt) - new Date(a.createdAt),
              );
              resolve(groups);
            };
            tx.onerror = (err) => reject(err);
          });
        }

        async function getUnlinkedSessions() {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_SESSIONS, "readonly");
            const store = tx.objectStore(STORE_SESSIONS);
            const request = store.getAll();
            request.onsuccess = () => {
              const all = request.result;
              const unlinked = all
                .filter((s) => !s.session_id)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
              resolve(unlinked);
            };
            request.onerror = (err) => reject(err);
            tx.oncomplete = () => db.close();
          });
        }

        async function addSession(type, note = "", session_id = null) {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_SESSIONS, "readwrite");
            const store = tx.objectStore(STORE_SESSIONS);
            const session = {
              type: type,
              note: note.trim() || (type === "work" ? "ä¸“æ³¨å·¥ä½œ" : "ä¼‘æ¯è°ƒæ•´"),
              timestamp: new Date().toISOString(),
            };
            if (session_id) session.session_id = session_id;
            const request = store.add(session);
            request.onsuccess = () => resolve(request.result);
            request.onerror = (err) => reject(err);
            tx.oncomplete = () => db.close();
          });
        }

        async function deleteSessionById(id) {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_SESSIONS, "readwrite");
            const store = tx.objectStore(STORE_SESSIONS);
            const request = store.delete(id);
            request.onsuccess = () => resolve(true);
            request.onerror = (err) => reject(err);
            tx.oncomplete = () => db.close();
          });
        }

        async function deleteAllData() {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(
              [STORE_SESSIONS, STORE_GROUPS],
              "readwrite",
            );
            tx.objectStore(STORE_SESSIONS).clear();
            tx.objectStore(STORE_GROUPS).clear();
            tx.oncomplete = () => {
              db.close();
              resolve();
            };
            tx.onerror = (err) => reject(err);
          });
        }

        // =======================  é•¿æç¤ºéŸ³ (9æ¬¡è„‰å†²ï¼Œçº¦4.5ç§’) =======================
        let audioCtx = null;
        let beepTimeouts = [];
        function initAudioContext() {
          if (!audioCtx)
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        async function ensureAudioContext() {
          if (!audioCtx) initAudioContext();
          if (audioCtx.state === "suspended") {
            try {
              await audioCtx.resume();
            } catch (e) {}
          }
        }
        function playShortBeep() {
          if (!audioCtx || audioCtx.state !== "running") return;
          const now = audioCtx.currentTime;
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = "sine";
          osc.frequency.value = 660;
          gain.gain.setValueAtTime(0.25, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start(now);
          osc.stop(now + 0.2);
        }
        function playBeep() {
          beepTimeouts.forEach((id) => clearTimeout(id));
          beepTimeouts = [];
          ensureAudioContext().then(() => {
            for (let i = 0; i < 9; i++) {
              beepTimeouts.push(setTimeout(() => playShortBeep(), i * 500));
            }
          });
        }

        // =======================  è®¡æ—¶å™¨é€»è¾‘ =======================
        let WORK_TIME = 25 * 60,
          BREAK_TIME = 5 * 60;
        let timerInterval = null,
          isRunning = false,
          currentMode = "work",
          timeLeft = WORK_TIME;
        let pendingSessionId = null; // æš‚å­˜å·¥ä½œäº§ç”Ÿçš„session_idï¼Œä¾›ä¼‘æ¯ä½¿ç”¨

        function formatTime(seconds) {
          return `${Math.floor(seconds / 60)
            .toString()
            .padStart(2, "0")}:${(seconds % 60).toString().padStart(2, "0")}`;
        }
        function updateUI() {
          $timerDisplay.text(formatTime(timeLeft));
          if (currentMode === "work") {
            $modeLabel.html('<i class="fas fa-tomato"></i> ä¸“æ³¨å·¥ä½œ');
            $modeLabel.css("background", "#ffb085");
          } else {
            $modeLabel.html('<i class="fas fa-mug-hot"></i> ä¼‘æ¯æ—¶é—´');
            $modeLabel.css("background", "#a5d0b0");
          }
        }
        function switchMode() {
          if (currentMode === "work") {
            currentMode = "break";
            timeLeft = BREAK_TIME;
          } else {
            currentMode = "work";
            timeLeft = WORK_TIME;
          }
          updateUI();
        }
        function stopTimer() {
          if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
          }
          isRunning = false;
          $startPauseIcon.removeClass("fa-pause").addClass("fa-play");
        }

        async function startTimer() {
          ensureAudioContext();
          if (timerInterval) clearInterval(timerInterval);
          isRunning = true;
          $startPauseIcon.removeClass("fa-play").addClass("fa-pause");
          timerInterval = setInterval(async () => {
            if (timeLeft > 0) {
              timeLeft--;
              updateUI();
            }
            if (timeLeft === 0) {
              playBeep();
              const mode = currentMode;
              let autoNote = mode === "work" ? "âœ… ç•ªèŒ„å®Œæˆ" : "â˜• ä¼‘æ¯ç»“æŸ";
              try {
                if (mode === "work") {
                  const session_id =
                    "group_" +
                    Date.now() +
                    "_" +
                    Math.random().toString(36).substring(2);
                  await addSession("work", autoNote, session_id);
                  await createGroup(
                    session_id,
                    "ç•ªèŒ„ä¼šè¯ " +
                      new Date().toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                      }),
                  );
                  pendingSessionId = session_id;
                } else {
                  if (pendingSessionId) {
                    await addSession("break", autoNote, pendingSessionId);
                    pendingSessionId = null;
                  } else {
                    await addSession("break", autoNote);
                  }
                }
                renderAllHistory();
              } catch (e) {
                console.error("è®°å½•å¤±è´¥", e);
              }
              switchMode();
              updateUI();
            }
          }, 1000);
        }
        function toggleTimer() {
          isRunning ? stopTimer() : startTimer();
        }
        function resetTimer() {
          stopTimer();
          timeLeft = currentMode === "work" ? WORK_TIME : BREAK_TIME;
          updateUI();
        }

        // è‡ªå®šä¹‰æ—¶é—´
        function updateWorkTimeFromInput() {
          let v = parseInt($workMinutesInput.val(), 10) || 25;
          $workMinutesInput.val(v);
          WORK_TIME = v * 60;
        }
        function updateBreakTimeFromInput() {
          let v = parseInt($breakMinutesInput.val(), 10) || 5;
          $breakMinutesInput.val(v);
          BREAK_TIME = v * 60;
        }
        function onWorkChange() {
          updateWorkTimeFromInput();
          if (!isRunning && currentMode === "work") {
            timeLeft = WORK_TIME;
            updateUI();
          }
        }
        function onBreakChange() {
          updateBreakTimeFromInput();
          if (!isRunning && currentMode === "break") {
            timeLeft = BREAK_TIME;
            updateUI();
          }
        }

        // =======================  æ¸²æŸ“ç»„ + å•æ¡è®°å½• =======================
        async function renderAllHistory() {
          // 1. æ¸²æŸ“ç»„
          const groups = await getAllGroupsWithSessions();
          let groupHtml = "";
          if (groups.length === 0) {
            groupHtml =
              '<div class="empty-history"><i class="fas fa-tomato" style="font-size:2rem; opacity:0.4;"></i><br>æš‚æ— ç•ªèŒ„ä¼šè¯ç»„</div>';
          } else {
            groups.forEach((group) => {
              const workSession = group.sessions.find((s) => s.type === "work");
              const breakSession = group.sessions.find(
                (s) => s.type === "break",
              );
              const workNote = workSession ? workSession.note : "";
              const breakNote = breakSession ? breakSession.note : "";
              const workTime = workSession
                ? new Date(workSession.timestamp).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  })
                : "";
              const breakTime = breakSession
                ? new Date(breakSession.timestamp).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  })
                : "";

              groupHtml += `<div class="group-item" data-session-id="${group.session_id}">
              <div class="group-header">
                <div class="group-title">
                  <span class="group-name">${group.name || "ç•ªèŒ„ä¼šè¯"}</span>
                  <span class="group-badge"><i class="far fa-clock"></i> ${new Date(group.createdAt).toLocaleDateString()}</span>
                </div>
                <div class="group-actions">
                  <button class="btn-icon edit-name-btn" data-id="${group.session_id}"><i class="fas fa-edit"></i>æ”¹å</button>
                  <button class="btn-icon edit-remark-btn" data-id="${group.session_id}"><i class="fas fa-pen"></i>å¤‡æ³¨</button>
                  <button class="btn-icon btn-delete-group delete-group-btn" data-id="${group.session_id}"><i class="fas fa-trash-alt"></i>åˆ é™¤ç»„</button>
                </div>
              </div>
              <div class="group-detail">
                <div class="session-row">
                  <span class="session-type work-type"><i class="fas fa-tomato"></i> å·¥ä½œ</span>
                  <span class="session-time"><i class="far fa-calendar-alt"></i> ${workTime}</span>
                  <span class="session-note"><i class="fas fa-quote-right"></i> ${workNote}</span>
                </div>
                <div class="session-row">
                  <span class="session-type break-type"><i class="fas fa-mug-hot"></i> ä¼‘æ¯</span>
                  <span class="session-time"><i class="far fa-calendar-alt"></i> ${breakTime}</span>
                  <span class="session-note"><i class="fas fa-quote-right"></i> ${breakNote}</span>
                </div>
              </div>
              <div class="group-footer">
                <div class="group-remark">
                  <i class="fas fa-paperclip" style="color: #b87c4b;"></i>
                  <span class="${group.remark ? "remark-text" : "empty-group-remark"}">${group.remark || "ç‚¹å‡»ã€Œå¤‡æ³¨ã€æ·»åŠ ç»„å¤‡æ³¨"}</span>
                </div>
              </div>
            </div>`;
            });
          }
          $("#groupListContainer").html(groupHtml);

          // ç»‘å®šç»„å†…æŒ‰é’®äº‹ä»¶
          $(".edit-name-btn").on("click", async function () {
            const session_id = $(this).data("id");
            const newName = prompt("è¯·è¾“å…¥æ–°çš„ç»„åç§°", "");
            if (newName !== null) {
              await updateGroup(session_id, {
                name: newName.trim() || "æœªå‘½å",
              });
              renderAllHistory();
            }
          });
          $(".edit-remark-btn").on("click", async function () {
            const session_id = $(this).data("id");
            const newRemark = prompt("ç¼–è¾‘ç»„å¤‡æ³¨", "");
            if (newRemark !== null) {
              await updateGroup(session_id, { remark: newRemark.trim() });
              renderAllHistory();
            }
          });
          $(".delete-group-btn").on("click", async function () {
            const session_id = $(this).data("id");
            if (confirm("ç¡®å®šåˆ é™¤è¯¥ç»„åŠå…¶æ‰€æœ‰è®°å½•å—ï¼Ÿ")) {
              await deleteGroupAndSessions(session_id);
              renderAllHistory();
            }
          });

          // 2. æ¸²æŸ“æœªåˆ†ç»„è®°å½•
          const singles = await getUnlinkedSessions();
          let singleHtml = "";
          if (singles.length === 0) {
            singleHtml =
              '<div class="empty-history" style="padding:15px;">æš‚æ— æ‰‹åŠ¨è®°å½•</div>';
          } else {
            singles.forEach((rec) => {
              const date = new Date(rec.timestamp);
              const dateStr = `${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`;
              const typeLabel = rec.type === "work" ? "ğŸ… å·¥ä½œ" : "ğŸ§˜ ä¼‘æ¯";
              singleHtml += `<div class="single-record-item" data-id="${rec.id}">
              <div><span class="badge-type" style="background:${rec.type === "work" ? "#fa9e79" : "#91c7a0"};">${typeLabel}</span>
              <span style="margin-left:16px;"><i class="fas fa-quote-right"></i> ${rec.note}</span>
              <span style="margin-left:20px; color:#9e7b62; font-size:0.9rem;"><i class="far fa-calendar-alt"></i> ${dateStr}</span></div>
              <button class="delete-btn" data-id="${rec.id}"><i class="fas fa-trash-alt"></i></button>
            </div>`;
            });
          }
          $("#singleRecordListContainer").html(singleHtml);
          $(".delete-btn")
            .off("click")
            .on("click", async function () {
              const id = $(this).data("id");
              if (confirm("åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ")) {
                await deleteSessionById(id);
                renderAllHistory();
              }
            });
        }

        // =======================  æ‰‹åŠ¨ä¿å­˜è®°å½•ï¼ˆæ— session_idï¼Œä¸åˆ†ç»„ï¼‰ =======================
        async function handleManualSave() {
          const type = $recordType.val();
          const note = $recordNote.val().trim();
          if (!note) {
            alert("è¯·è¾“å…¥å¤‡æ³¨");
            return;
          }
          await addSession(type, note, null);
          $recordNote.val("");
          renderAllHistory();
        }

        // =======================  æ—¥æœŸ & é¼“åŠ±è¯­ =======================
        function updateDateInfo() {
          const now = new Date();
          const weekdays = [
            "æ˜ŸæœŸæ—¥",
            "æ˜ŸæœŸä¸€",
            "æ˜ŸæœŸäºŒ",
            "æ˜ŸæœŸä¸‰",
            "æ˜ŸæœŸå››",
            "æ˜ŸæœŸäº”",
            "æ˜ŸæœŸå…­",
          ];
          $("#currentDateDisplay").text(
            `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ${weekdays[now.getDay()]}`,
          );
          $("#daysInMonth").text(
            new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate(),
          );
        }
        const encouragementList = [
          "ğŸ€ æ¯ä¸€åˆ†é’Ÿéƒ½å€¼å¾—è®¤çœŸå¯¹å¾…",
          "â­ å†åšæŒä¸€ä¸‹ï¼Œå¿«å®Œæˆäº†ï¼",
          "ğŸ’ª ä½ æ¯”æƒ³è±¡ä¸­æ›´å¼ºå¤§",
          "ğŸŒ» ä¸“æ³¨æ˜¯æœ€é«˜çº§çš„è‡ªå¾‹",
          "ğŸ¯ ä»Šå¤©çš„ç•ªèŒ„æ ¼å¤–é¦™ç”œ",
          "ğŸŒ¸ ä¼‘æ¯æ˜¯ä¸ºäº†èµ°æ›´è¿œçš„è·¯",
          "ğŸ”¥ ä½ å·²ç»å¾ˆæ£’äº†ï¼Œç»§ç»­åŠ æ²¹",
          "ğŸŒˆ å®Œæˆä¸€ä¸ªç•ªèŒ„ï¼Œç¦»ç›®æ ‡æ›´è¿‘ä¸€æ­¥",
          "ğŸ… ä»Šæ—¥ç•ªèŒ„ï¼Œæ˜æ—¥ç¡•æœ",
          "âœ¨ å¿ƒæ— æ—éª›ï¼Œä¸‡äº‹å¯ç ´",
        ];
        function setRandomEncouragement() {
          $("#encourageMessage").text(
            encouragementList[
              Math.floor(Math.random() * encouragementList.length)
            ],
          );
        }

        // =======================  é¡µé¢åˆå§‹åŒ– =======================
        $(document).ready(async function () {
          initAudioContext();
          try {
            await openDB();
          } catch (e) {
            alert("IndexedDBåˆå§‹åŒ–å¤±è´¥");
          }

          // åˆå§‹åŒ–è‡ªå®šä¹‰æ—¶é—´
          updateWorkTimeFromInput();
          updateBreakTimeFromInput();
          timeLeft = WORK_TIME;
          updateUI();
          updateDateInfo();
          setRandomEncouragement();
          await renderAllHistory();

          // äº‹ä»¶ç»‘å®šï¼ˆä½¿ç”¨å·²ç»åœ¨å¼€å¤´å®šä¹‰çš„å˜é‡ï¼‰
          $workMinutesInput.on("change", onWorkChange);
          $breakMinutesInput.on("change", onBreakChange);
          $startPauseBtn.on("click", toggleTimer);
          $resetBtn.on("click", resetTimer);
          $testSoundBtn.on("click", playBeep); // å£°éŸ³æµ‹è¯•
          $saveRecordBtn.on("click", handleManualSave);
          $recordNote.on("keypress", function (e) {
            if (e.which === 13) {
              e.preventDefault();
              handleManualSave();
            }
          });
          $refreshEncourageBtn.on("click", setRandomEncouragement);

          // ä¸€é”®åˆ é™¤æ‰€æœ‰
          $clearAllBtn.on("click", async function () {
            if (confirm("âš ï¸ ç¡®å®šåˆ é™¤æ‰€æœ‰ç•ªèŒ„ä¼šè¯ç»„å’Œè®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
              await deleteAllData();
              pendingSessionId = null;
              renderAllHistory();
            }
          });

          $(window).on("beforeunload", function () {
            if (timerInterval) clearInterval(timerInterval);
            beepTimeouts.forEach(clearTimeout);
          });
        });
      })();
    </script>
  </body>
</html>
